name: Release
on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'
      - '[0-9]+.[0-9]+.[0-9]+-*'
env:
  DOTNET_NOLOGO: true
jobs:
  release:
    runs-on: windows-2019 # Code signing requirement https://github.com/NuGet/Home/issues/7939
    steps:
      - name: Checkout
        uses: actions/checkout@v2.3.4
        with:
          fetch-depth: 0
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v1.7.2
        with:
          dotnet-version: 5.0.x
      - name: Build
        run: dotnet build src --configuration Release
      - name: Get signing cert
        run: |
          [IO.File]::WriteAllBytes("signing-cert.pfx", [Convert]::FromBase64String("${{ secrets.NUGET_SIGNING_CERT_BASE64 }}"))
        shell: pwsh
      - name: Setup NuGet for signing
        uses: nuget/setup-nuget@v1.0.5
      - name: Sign NuGet Packages
        run: nuget sign nugets\*.nupkg -CertificatePath signing-cert.pfx -Timestamper "http://timestamp.digicert.com/?alg=sha256" -NonInteractive
        shell: pwsh
      - name: Publish artifacts
        uses: actions/upload-artifact@v2.2.2
        with:
          name: nugets
          path: nugets/*
          retention-days: 1
      - name: Push packages to MyGet
        run: dotnet nuget push nugets\*.nupkg --api-key ${{ secrets.MYGET_PUBLISH_API_KEY }} --source "https://www.myget.org/F/particular/api/v3/index.json"
        shell: pwsh